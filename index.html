<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Concrete Schedule Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        max-width: 980px;
        margin: 20px auto;
        padding: 0 16px;
        background: #f5f5f5;
      }
      h1 {
        margin-bottom: 4px;
      }
      p {
        color: #555;
      }
      .card {
        background: #ffffff;
        border-radius: 10px;
        padding: 16px;
        margin-top: 16px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      label {
        display: block;
        margin-top: 12px;
        font-weight: 700;
        font-size: 14px;
      }
      input[type="date"],
      textarea,
      button {
        margin-top: 6px;
        width: 100%;
        box-sizing: border-box;
      }
      textarea {
        min-height: 160px;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #ccc;
        font-size: 13px;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
      }
      button {
        padding: 10px 12px;
        font-size: 14px;
        cursor: pointer;
        border-radius: 8px;
        border: 1px solid #ccc;
        background: #fff;
      }
      .row {
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px;
      }
      @media (min-width: 820px) {
        .row {
          grid-template-columns: 1fr 1fr;
        }
      }
      .status {
        margin-top: 10px;
        font-size: 14px;
      }
      pre {
        background: #eee;
        padding: 10px;
        border-radius: 8px;
        font-size: 12px;
        max-height: 280px;
        overflow: auto;
      }
      .hint {
        font-size: 12px;
        color: #666;
        line-height: 1.4;
      }
    </style>
  </head>

  <body>
    <h1>Concrete Schedule Admin</h1>
    <p>
      Paste the schedule rows for a given date, then click <b>Save schedule</b>.
      The mobile app will load the same date from the API.
    </p>

    <div class="card">
      <div class="row">
        <div>
          <label for="date">Schedule date</label>
          <input id="date" type="date" />

          <div class="hint" style="margin-top: 10px">
            Format (one line per placement):
            <br />
            <b>time, jobNumber, description, orderedCY</b>
            <br /><br />
            Example:
            <br />
            <code>8:00 AM, K008/15755, Finishing Mill - Coil Handling NW Wall, 60</code>
          </div>
        </div>

        <div>
          <label for="rows">Paste schedule rows</label>
          <textarea
            id="rows"
            placeholder="Paste rows here..."
          ></textarea>
          <button id="saveBtn">Save schedule</button>
          <div class="status" id="saveStatus"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Check whatâ€™s saved for a date</h2>
      <div class="row">
        <div>
          <label for="checkDate">Date</label>
          <input id="checkDate" type="date" />
          <button id="loadBtn">Load saved schedule</button>
        </div>
        <div>
          <label>Result</label>
          <pre id="output">(nothing loaded yet)</pre>
        </div>
      </div>
    </div>

    <script>
      // This uses your own Netlify Functions on the same site.
      const saveUrl = "/.netlify/functions/saveSchedule";
      const getUrl = "/.netlify/functions/getSchedule";

      function parseRowsToPlacements(text, date) {
        const lines = text.split("\n").map((l) => l.trim()).filter(Boolean);

        const placements = [];
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i];

          // Try comma split first; if not enough columns, try tab
          let parts = line.split(",").map((p) => p.trim());
          if (parts.length < 3) {
            parts = line.split("\t").map((p) => p.trim());
          }

          if (parts.length < 3) continue;

          const time = parts[0] || "";
          const jobNumber = parts[1] || "";
          const description = parts[2] || "";
          const orderQuantityCY = parts[3] ? Number(parts[3]) : null;

          placements.push({
            id: `${date}-${i + 1}`,
            pourDate: date,
            time,
            jobNumber,
            description,
            orderQuantityCY: Number.isFinite(orderQuantityCY) ? orderQuantityCY : null
          });
        }

        return placements;
      }

      document.getElementById("saveBtn").onclick = async () => {
        const date = document.getElementById("date").value;
        const rows = document.getElementById("rows").value;
        const status = document.getElementById("saveStatus");

        if (!date) {
          status.textContent = "Please choose a date.";
          return;
        }
        if (!rows.trim()) {
          status.textContent = "Please paste some rows.";
          return;
        }

        const placements = parseRowsToPlacements(rows, date);
        if (placements.length === 0) {
          status.textContent =
            "No valid rows found. Make sure each line has at least: time, job, description.";
          return;
        }

        status.textContent = "Saving...";
        try {
          const res = await fetch(saveUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ date, placements })
          });

          const json = await res.json();
          if (!res.ok || !json.ok) {
            status.textContent = "Error: " + (json.error || "Unknown error");
            return;
          }

          status.textContent = `Saved ${json.count} placements for ${json.date}.`;
        } catch (e) {
          status.textContent = "Error: " + e.message;
        }
      };

      document.getElementById("loadBtn").onclick = async () => {
        const date = document.getElementById("checkDate").value;
        const output = document.getElementById("output");

        if (!date) {
          output.textContent = "Please choose a date.";
          return;
        }

        output.textContent = "Loading...";
        try {
          const res = await fetch(`${getUrl}?date=${encodeURIComponent(date)}`);
          const json = await res.json();
          output.textContent = JSON.stringify(json, null, 2);
        } catch (e) {
          output.textContent = "Error: " + e.message;
        }
      };
    </script>
  </body>
</html>
